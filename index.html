<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Follow UP_SARIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; font-weight: 400; color: #1e293b; line-height: 1.6; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 24px; border-radius: 2.5rem; width: 95%; max-width: 500px; border: 1px solid rgba(255,255,255,0.2); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .toast { display: none; position: fixed; bottom: 20px; right: 20px; padding: 16px 32px; border-radius: 16px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: all 0.3s; }
        .toast-error { background: #ef4444; color: white; }
        .toast-success { background: #10b981; color: white; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 md:p-8">
    <div id="toast" class="toast">แจ้งเตือน</div>

    <div class="max-w-4xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-gray-100">
        <!-- Banner แจ้งเตือนงานวันนี้ -->
        <div id="todayBanner" class="hidden bg-rose-600 p-3 text-white text-center text-sm font-semibold animate-pulse">
            <i class="fas fa-bell mr-2"></i> วันนี้มีงานต้องส่ง! <span id="todayCount">0</span> รายการ <button onclick="switchTab('dashboard')" class="underline ml-2 font-bold">คลิกดู</button>
        </div>

        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 p-8 text-white flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-semibold uppercase tracking-tight italic">Work Follow UP_SARIN</h1>
                <p class="text-indigo-100 text-xs font-light uppercase tracking-widest opacity-80 mt-1">Maintenance Tracking System</p>
            </div>
            <button onclick="fetchData()" class="bg-white/20 p-4 rounded-3xl hover:bg-white/30 transition-all shadow-lg" title="รีเฟรชข้อมูล"><i class="fas fa-sync-alt text-xl"></i></button>
        </div>

        <div class="p-6 md:p-10">
            <!-- Tabs -->
            <div class="flex border-b-2 border-slate-50 mb-8 overflow-x-auto scrollbar-hide">
                <button onclick="switchTab('active')" id="tabActive" class="flex-1 min-w-[120px] py-4 tab-active transition-all uppercase text-sm font-semibold tracking-wider">บันทึกงาน</button>
                <button onclick="switchTab('dashboard')" id="tabDashboard" class="flex-1 min-w-[120px] py-4 text-slate-400 transition-all uppercase text-sm font-semibold tracking-wider">Dashboard</button>
                <button onclick="switchTab('history')" id="tabHistory" class="flex-1 min-w-[120px] py-4 text-slate-400 transition-all uppercase text-sm font-semibold tracking-wider">ประวัติซ่อม</button>
            </div>

            <!-- กรองข้อมูล -->
            <div id="filterContainer" class="hidden bg-slate-50 p-6 rounded-[2rem] border border-slate-200 mb-8 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-[11px] font-medium text-slate-400 uppercase mb-1">กรองตามเดือน</label>
                        <select id="filterMonth" onchange="render()" class="w-full px-4 py-3 border border-slate-200 rounded-2xl bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <option value="">ทั้งหมดทุกเดือน</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-medium text-slate-400 uppercase mb-1">กรองตาม Mold</label>
                        <select id="filterAsset" onchange="render()" class="w-full px-4 py-3 border border-slate-200 rounded-2xl bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            <option value="">ทั้งหมดที่มีงาน</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="resetFilters()" class="w-full bg-indigo-50 text-indigo-600 py-3 rounded-2xl text-xs font-semibold uppercase hover:bg-indigo-100 transition-colors">ล้างการกรอง</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardSection" class="hidden">
                <div id="overdueAlertBox" class="hidden mb-8 bg-rose-500 p-6 rounded-[2rem] shadow-lg shadow-rose-100">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-white/20 p-3 rounded-2xl text-white"><i class="fas fa-exclamation-triangle text-3xl"></i></div>
                        <div class="ml-4 text-white">
                            <p class="text-xl font-semibold uppercase leading-tight">พบงานที่เลยกำหนดส่ง!</p>
                            <p class="opacity-90 text-sm mt-0.5">ขณะนี้มีงาน <span id="overdueAlertCount" class="font-semibold underline underline-offset-4">0</span> รายการที่ล่าช้า โปรดเร่งแก้ไข</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 text-center text-slate-600">
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm"><p class="text-[11px] font-bold uppercase">รวมงาน</p><p id="statTotal" class="text-4xl font-semibold">0</p></div>
                    <div class="bg-amber-50 p-6 rounded-[2.5rem] border border-amber-100"><p class="text-[11px] font-bold uppercase">กำลังทำ</p><p id="statPending" class="text-4xl font-semibold">0</p></div>
                    <div class="bg-emerald-50 p-6 rounded-[2.5rem] border border-emerald-100"><p class="text-[11px] font-bold uppercase">เสร็จแล้ว</p><p id="statCompleted" class="text-4xl font-semibold">0</p></div>
                    <div class="bg-rose-50 p-6 rounded-[2.5rem] border border-rose-100"><p class="text-[11px] font-bold uppercase">เลยกำหนด</p><p id="statOverdue" class="text-4xl font-semibold text-rose-600">0</p></div>
                </div>
                <div id="dashList" class="space-y-5"></div>
            </div>

            <!-- หน้าบันทึกงาน -->
            <div id="activeSection">
                <details class="bg-slate-50 rounded-[2.5rem] mb-10 border border-slate-200 overflow-hidden shadow-sm" open>
                    <summary class="p-6 cursor-pointer font-medium text-slate-700 hover:bg-slate-100 select-none flex items-center transition-all">
                        <i class="fas fa-plus-circle text-indigo-500 mr-3 text-xl"></i>บันทึกงานใหม่ / แจ้งซ่อม
                    </summary>
                    <div class="p-8 pt-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ชื่องาน / รายละเอียด</label>
                            <input type="text" id="taskInput" placeholder="ระบุอาการเสียหรือชื่องาน..." class="w-full px-5 py-4 border border-slate-200 rounded-[1.5rem] outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ประเภทงาน</label>
                            <select id="typeInput" class="w-full px-5 py-4 border border-slate-200 rounded-[1.5rem] bg-white outline-none">
                                <option>Repair Mold</option><option>Fit flashing Mold</option><option>TPM Mold</option><option>Machine modify</option><option>New Machine</option><option>Other</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">เลือก Mold (พิมพ์ค้นหา)</label>
                            <div class="relative flex items-center">
                                <input type="text" id="assetInput" list="assetList" oninput="toggleOther(this.value)" onfocus="this.select()" placeholder="รหัสหรือชื่อ..." class="w-full px-5 py-4 pr-12 border border-slate-200 rounded-[1.5rem] outline-none focus:ring-2 focus:ring-indigo-500 font-semibold">
                                <button type="button" onclick="resetAssetInput()" class="absolute right-4 text-slate-300 hover:text-rose-500 transition-colors"><i class="fas fa-times-circle text-lg"></i></button>
                            </div>
                            <datalist id="assetList"></datalist>
                        </div>
                        <div id="otherAssetWrapper" class="hidden md:col-span-2 bg-indigo-50 p-6 rounded-[2rem] border-2 border-dashed border-indigo-200">
                            <label class="text-[11px] font-bold text-indigo-600 uppercase mb-2 block">ระบุชื่อ Mold ใหม่</label>
                            <input type="text" id="otherAssetInput" placeholder="ชื่อ Mold..." class="w-full px-5 py-4 border border-indigo-200 rounded-[1.2rem] bg-white outline-none font-medium">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ผู้จัดทำ (Dept)</label>
                            <select id="deptInput" onchange="toggleDeptOther(this.value)" class="w-full px-5 py-4 border border-slate-200 rounded-[1.5rem] bg-white outline-none font-medium text-indigo-600">
                                <option value="">-- เลือกผู้จัดทำ --</option>
                                <option value="TP/MDS">1. TP/MDS</option>
                                <option value="PE">2. PE</option>
                                <option value="Other">3. Other (ระบุเอง)</option>
                            </select>
                        </div>
                        <div id="otherDeptWrapper" class="hidden bg-slate-100 p-5 rounded-[1.5rem] border border-slate-200">
                            <label class="block text-[11px] font-medium text-slate-500 uppercase mb-1">ระบุผู้จัดทำอื่น ๆ</label>
                            <input type="text" id="otherDeptInput" placeholder="พิมพ์ชื่อผู้จัดทำ..." class="w-full px-4 py-2 border border-slate-300 rounded-xl">
                        </div>
                        <div class="md:col-span-2 grid grid-cols-2 gap-4">
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">วันเริ่มงาน</label><input type="date" id="startInput" class="w-full px-5 py-4 border border-slate-200 rounded-[1.5rem] outline-none"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">กำหนดเสร็จ (Deadline)</label><input type="date" id="endInput" class="w-full px-5 py-4 border border-slate-200 rounded-[1.5rem] outline-none font-semibold text-rose-600"></div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">รูปภาพแจ้งซ่อม</label>
                            <input type="file" multiple accept="image/*" id="fileIn" onchange="handleImg(this, 'preIn', 'in')" class="text-xs w-full p-6 border-2 border-dashed border-slate-200 rounded-[1.5rem] bg-white">
                            <div id="preIn" class="flex flex-wrap gap-3 mt-4"></div>
                        </div>
                        <button onclick="save()" id="saveBtn" class="md:col-span-2 bg-indigo-600 text-white py-5 rounded-[2rem] font-medium uppercase tracking-widest shadow-xl shadow-indigo-100 flex justify-center items-center gap-3 transition-all active:scale-95 hover:bg-indigo-700">
                            <i class="fas fa-save text-xl"></i> บันทึกข้อมูลงาน <div class="loader" id="saveLd"></div>
                        </button>
                    </div>
                </details>
                <div id="listActive" class="space-y-6"></div>
            </div>

            <!-- History -->
            <div id="historySection" class="hidden"><div id="listHistory" class="space-y-5"></div></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal"><div class="modal-content shadow-2xl animate-in zoom-in fade-in duration-300">
        <div class="flex justify-between items-center mb-6 border-b pb-4 text-indigo-700 font-medium">
            <h2 class="text-2xl uppercase italic font-semibold">แก้ไขข้อมูลงาน</h2>
            <button onclick="closeM('editModal')" class="text-slate-300 hover:text-rose-500 p-2"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div class="space-y-6">
            <input type="hidden" id="edId">
            <div><label class="text-[11px] font-medium text-slate-400 uppercase mb-1 block">ชื่องาน</label><input type="text" id="edTask" class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none"></div>
            <div><label class="text-[11px] font-medium text-slate-400 uppercase mb-1 block">กำหนดเสร็จใหม่ (Deadline)</label><input type="date" id="edEnd" class="w-full px-5 py-4 border border-slate-200 rounded-2xl outline-none font-semibold text-rose-600"></div>
            <div><label class="text-[11px] font-medium text-slate-400 uppercase mb-1 block">ระบุเหตุผล</label><textarea id="edReason" rows="3" class="w-full px-5 py-4 border border-slate-200 rounded-2xl text-sm outline-none" placeholder="ระบุเหตุผล..."></textarea></div>
            <button onclick="update()" id="upBtn" class="w-full bg-indigo-600 text-white py-5 rounded-[1.5rem] font-medium uppercase tracking-wider shadow-lg flex justify-center items-center gap-3 active:scale-95"><i class="fas fa-check-circle text-xl"></i> ยืนยันการอัปเดต <div class="loader" id="upLd"></div></button>
        </div>
    </div></div>

    <div id="compModal" class="modal"><div class="modal-content shadow-2xl text-center p-12 animate-in zoom-in duration-300">
        <div class="bg-emerald-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600"><i class="fas fa-check-double text-4xl"></i></div>
        <h2 class="text-3xl font-semibold text-slate-800 mb-2 uppercase">ปิดงานซ่อม</h2><p class="text-xs text-slate-400 mb-8 italic">แนบรูปภาพหลังซ่อมเสร็จเพื่อเก็บเป็นประวัติ (ถ้ามี)</p>
        <div class="text-left mb-10"><input type="file" multiple accept="image/*" id="fileOut" onchange="handleImg(this, 'preOut', 'out')" class="text-xs w-full p-4 border-2 border-dashed border-slate-100 rounded-2xl"><div id="preOut" class="flex flex-wrap gap-2 mt-4 justify-center"></div></div>
        <div class="flex gap-4 font-medium"><button onclick="closeM('compModal')" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-bold uppercase hover:bg-slate-200">ยกเลิก</button><button onclick="complete()" id="cpBtn" class="flex-[2] bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 flex justify-center items-center gap-2 active:scale-95 uppercase">ยืนยันปิดรายการ <div class="loader" id="cpLd"></div></button></div>
    </div></div>

    <div id="delModal" class="modal"><div class="modal-content shadow-2xl text-center p-12 animate-in zoom-in duration-300">
        <div class="bg-rose-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-600"><i class="fas fa-trash-alt text-4xl"></i></div>
        <h2 class="text-2xl font-semibold text-slate-800 mb-2 uppercase">ยืนยันการลบ?</h2>
        <p class="text-sm text-slate-400 mb-10">ข้อมูลนี้จะถูกลบออกจากระบบอย่างถาวร</p>
        <div class="flex gap-4 font-medium">
            <button onclick="closeM('delModal')" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-2xl font-bold uppercase hover:bg-slate-200">ยกเลิก</button>
            <button onclick="confirmDel()" id="delBtn" class="flex-[2] bg-rose-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-rose-100 hover:bg-rose-700 flex justify-center items-center gap-2 active:scale-95 uppercase">
                ยืนยันการลบ <div class="loader" id="delLd"></div>
            </button>
        </div>
    </div></div>

    <script>
        // --- 1. CONFIG & STATE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX4EWwdUgmL9KqL_lKmTuh0-K6TGhAO-UVwa0dka2aQkkkOV_OrffP7VvVzOMPLTtzjQ/exec";
        let tasks = [], inImgs = [], outImgs = [], masterAssets = [], curId = "", currentTab = "active", targetDelId = "";

        // --- 2. HELPERS & UTILITIES ---
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast'); if(!toast) return;
            toast.innerText = msg; toast.className = `toast toast-${type}`;
            toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        /**
         * ฟังก์ชันแปลงรูปแบบวันที่ให้เป็น พ.ศ.
         */
        function formatThaiDate(dateStr) {
            if (!dateStr || dateStr === "-" || dateStr === "") return "-";
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear() + 543;
                return `${day}/${month}/${year}`;
            } catch (e) { return dateStr; }
        }

        function closeM(id) { const el = document.getElementById(id); if(el) el.style.display = 'none'; }

        // --- 3. DATA ACTIONS ---
        
        async function fetchWithRetry(url, options = {}, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response;
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        async function fetchData() {
            try {
                const res = await fetchWithRetry(SCRIPT_URL.trim());
                const data = await res.json();
                tasks = data.tasks || [];
                masterAssets = data.assets || [];
                updateMasterAssetList();
                updateFilters();
                render();
            } catch (e) {
                console.error("Fetch Error:", e);
                showToast("ดึงข้อมูลล้มเหลว โปรดลองรีเฟรชหน้าเว็บ", 'error');
            }
        }

        async function handleImg(input, preId, type) {
            const pre = document.getElementById(preId); if(!pre) return; pre.innerHTML = '';
            const target = type === 'in' ? inImgs : outImgs; target.length = 0;
            if (input.files) {
                for (let f of Array.from(input.files)) {
                    const reader = new FileReader(); reader.readAsDataURL(f);
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const can = document.createElement('canvas'); const ctx = can.getContext('2d');
                            let w = img.width, h = img.height; if(w > 1000) { h = (1000/w)*h; w = 1000; }
                            can.width = w; can.height = h; ctx.drawImage(img, 0, 0, w, h);
                            const b64 = can.toDataURL('image/jpeg', 0.6); target.push(b64);
                            const i = document.createElement('img'); i.src = b64; i.className = "w-20 h-20 object-cover rounded-2xl border border-slate-100 shadow-sm"; pre.appendChild(i);
                        };
                    };
                }
            }
        }

        // --- 4. CRUD ACTIONS ---

        async function save() {
            const task = document.getElementById('taskInput').value;
            const start = document.getElementById('startInput').value;
            const end = document.getElementById('endInput').value;
            if(!task || !start || !end) return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
            const btn = document.getElementById('saveBtn'); const ld = document.getElementById('saveLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            let asset = document.getElementById('assetInput').value.trim();
            if(asset === "อื่นๆ (ระบุเอง)") asset = document.getElementById('otherAssetInput').value.trim();
            let dept = document.getElementById('deptInput').value;
            if(dept === "Other") dept = document.getElementById('otherDeptInput').value.trim();
            try {
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "add", task, type: document.getElementById('typeInput').value, asset, startDate: start, deadline: end, images: inImgs, vendor: dept }) });
                showToast("บันทึกข้อมูลเรียบร้อย"); setTimeout(() => location.reload(), 1000);
            } catch(e) { showToast("บันทึกไม่สำเร็จ", 'error'); btn.disabled = false; if(ld) ld.style.display = "none"; }
        }

        async function update() {
            const id = document.getElementById('edId').value;
            const task = document.getElementById('edTask').value;
            const deadline = document.getElementById('edEnd').value;
            const reason = document.getElementById('edReason').value;
            if(!reason) return alert("กรุณาระบุเหตุผล");
            const btn = document.getElementById('upBtn'); const ld = document.getElementById('upLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            try {
                const idx = tasks.findIndex(t => t.id === id);
                if(idx !== -1) { tasks[idx].task = task; tasks[idx].deadline = deadline; tasks[idx].reason = reason; }
                render();
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "update", id, task, deadline, reason }) });
                showToast("อัปเดตข้อมูลสำเร็จ"); closeM('editModal'); await fetchData();
            } catch (e) { showToast("อัปเดตล้มเหลว", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; }
        }

        async function complete() {
            const btn = document.getElementById('cpBtn'); const ld = document.getElementById('cpLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            try {
                const idx = tasks.findIndex(t => t.id === curId);
                if(idx !== -1) tasks[idx].status = 'completed';
                render();
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "complete", id: curId, images: outImgs }) });
                showToast("ปิดงานสำเร็จ"); closeM('compModal'); await fetchData();
            } catch (e) { showToast("ปิดงานไม่สำเร็จ", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; }
        }

        async function confirmDel() {
            if(!targetDelId) return;
            const btn = document.getElementById('delBtn'); const ld = document.getElementById('delLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            const oldTasks = [...tasks];
            tasks = tasks.filter(t => t.id !== targetDelId);
            render();
            try {
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", id: targetDelId }) });
                showToast("ลบข้อมูลสำเร็จ"); closeM('delModal');
            } catch(e) { tasks = oldTasks; render(); showToast("ลบไม่สำเร็จ กรุณาลองใหม่", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; targetDelId = ""; }
        }

        // --- 5. INTERFACE HELPERS ---

        function updateMasterAssetList() {
            const list = document.getElementById('assetList'); if(!list) return;
            const valid = masterAssets.filter(a => { const t = (typeof a === 'object') ? a.fullText : a; return t && t.trim() !== "" && t.trim() !== "-" && !String(t).includes("undefined"); }).map(a => `<option value="${(typeof a === 'object') ? a.fullText : a}">`).join('');
            list.innerHTML = valid + '<option value="อื่นๆ (ระบุเอง)">';
        }

        function updateFilters() {
            const fA = document.getElementById('filterAsset'); const fM = document.getElementById('filterMonth');
            if(!fA || !fM) return;
            let relevantStatus = currentTab === 'dashboard' ? 'pending' : 'completed';
            const moldsInView = [...new Set(tasks.filter(t => t.status === relevantStatus).map(t => t.asset))].sort();
            fA.innerHTML = '<option value="">ทั้งหมดที่มีงาน</option>' + moldsInView.map(a => `<option value="${a}">${a}</option>`).join('');
            const uniqueMonths = [...new Set(tasks.filter(t => t.deadline).map(t => t.deadline.toString().substring(0, 7)))].filter(m => m).sort().reverse();
            fM.innerHTML = '<option value="">ทั้งหมดทุกเดือน</option>' + uniqueMonths.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function switchTab(mode) {
            currentTab = mode; if (mode === 'active') resetFilters();
            ['tabActive', 'tabDashboard', 'tabHistory'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.classList.remove('tab-active', 'text-indigo-600', 'text-slate-800'); if(id !== 'tab' + mode.charAt(0).toUpperCase() + mode.slice(1)) el.classList.add('text-slate-400'); }
            });
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('tab-active');
            ['activeSection', 'dashboardSection', 'historySection'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            document.getElementById(mode + 'Section').classList.remove('hidden');
            document.getElementById('filterContainer').className = (mode === 'dashboard' || mode === 'history') ? 'block bg-slate-50 p-6 rounded-[2rem] border border-slate-200 mb-8' : 'hidden';
            updateFilters(); render();
        }

        function openEdit(id) {
            const t = tasks.find(x => x.id === id); if(!t) return;
            document.getElementById('edId').value = t.id;
            document.getElementById('edTask').value = t.task;
            document.getElementById('edEnd').value = t.deadline || "";
            document.getElementById('edReason').value = t.reason || "";
            document.getElementById('editModal').style.display = 'block';
        }

        function openComp(id) {
            curId = id; outImgs = []; document.getElementById('preOut').innerHTML = '';
            document.getElementById('compModal').style.display = 'block';
        }

        function openDel(id) {
            targetDelId = id;
            document.getElementById('delModal').style.display = 'block';
        }

        function toggleOther(v) { const el = document.getElementById('otherAssetWrapper'); if(el) el.className = v.trim() === "อื่นๆ (ระบุเอง)" ? "block mb-6" : "hidden"; }
        function toggleDeptOther(v) { const el = document.getElementById('otherDeptWrapper'); if(el) el.className = v === "Other" ? "block mb-6" : "hidden"; }
        function resetAssetInput() { const el = document.getElementById('assetInput'); if(el) { el.value = ""; toggleOther(""); el.focus(); } }
        function resetFilters() { const fm = document.getElementById('filterMonth'); const fa = document.getElementById('filterAsset'); if(fm) fm.value = ""; if(fa) fa.value = ""; render(); }

        // --- 6. RENDER ENGINE ---
        function render() {
            const today = new Date().toLocaleDateString('en-CA'); 
            const fm = document.getElementById('filterMonth') ? document.getElementById('filterMonth').value : "";
            const fa = document.getElementById('filterAsset') ? document.getElementById('filterAsset').value : "";
            
            const filtered = tasks.filter(t => (!fa || t.asset === fa) && (!fm || (t.deadline && String(t.deadline).startsWith(fm))));
            const activeFiltered = filtered.filter(t => t.status === 'pending');
            const doneFiltered = filtered.filter(t => t.status === 'completed');
            const activeAll = tasks.filter(t => t.status === 'pending');
            const overdueAll = activeAll.filter(t => t.deadline && t.deadline < today);

            if(document.getElementById('statTotal')) document.getElementById('statTotal').innerText = filtered.length;
            if(document.getElementById('statPending')) document.getElementById('statPending').innerText = activeFiltered.length;
            if(document.getElementById('statCompleted')) document.getElementById('statCompleted').innerText = doneFiltered.length;
            if(document.getElementById('statOverdue')) document.getElementById('statOverdue').innerText = activeFiltered.filter(t => t.deadline && t.deadline < today).length;

            const alertBox = document.getElementById('overdueAlertBox');
            if(alertBox) { if(overdueAll.length > 0) { alertBox.classList.remove('hidden'); document.getElementById('overdueAlertCount').innerText = overdueAll.length; } else { alertBox.classList.add('hidden'); } }

            const makeItem = t => {
                const isOver = t.status === 'pending' && t.deadline < today;
                const imgs = (t.imageUrl ? t.imageUrl.split(',') : []).concat(t.finishImageUrl ? t.finishImageUrl.split(',') : []).filter(u=>u&&String(u).startsWith('http')).map(u => `<img src="${u}" onclick="window.open('${u}')" class="w-16 h-16 object-cover rounded-xl border border-slate-100 shadow-sm cursor-pointer hover:scale-105 transition-all">`).join('');
                return `
                <div class="bg-white border-2 ${isOver ? 'border-rose-400 bg-rose-50/20' : 'border-slate-50 shadow-sm'} p-7 rounded-[3rem] hover:shadow-xl transition-all group animate-in fade-in duration-500">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex gap-2 items-center mb-4">
                                <span class="text-[10px] font-medium px-3 py-1 rounded-full ${isOver?'bg-rose-600 text-white':'bg-slate-100 text-slate-500'} uppercase tracking-widest">${t.type}</span>
                                ${isOver?'<span class="text-[10px] font-medium px-3 py-1 rounded-full bg-rose-100 text-rose-700 animate-pulse uppercase tracking-widest">ล่าช้า!</span>':''}
                                ${t.status==='completed'?'<span class="text-[10px] font-medium px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 uppercase tracking-widest">สำเร็จ</span>':''}
                            </div>
                            <h3 class="text-2xl font-semibold text-indigo-950 leading-none mb-2 uppercase tracking-tighter">${t.asset||'N/A'}</h3>
                            <div class="mt-1 space-y-1">
                                <p class="text-sm text-slate-600 font-medium tracking-tight"><i class="fas fa-tools mr-2 text-indigo-300"></i>${t.task}</p>
                                <p class="text-[12px] text-indigo-500 font-bold italic"><i class="fas fa-user-shield mr-2"></i>Responsible: ${t.vendor||'N/A'}</p>
                            </div>
                            <div class="mt-5 p-5 rounded-[2rem] ${isOver?'bg-rose-100/40':'bg-slate-50'} border border-transparent inline-flex flex-wrap items-center gap-3">
                                <div class="flex items-center text-[10px] font-medium text-slate-400 uppercase tracking-widest"><i class="far fa-calendar-alt mr-2 text-xl"></i> ${formatThaiDate(t.startDate)} – </div>
                                <div class="text-2xl font-bold text-rose-600 tracking-tighter">${formatThaiDate(t.deadline)}</div>
                            </div>
                            ${t.reason?`<div class="mt-4 p-4 bg-amber-50 rounded-[1.5rem] border-2 border-amber-100 text-sm text-amber-800 italic shadow-inner"><b>หมายเหตุ:</b> ${t.reason}</div>`:''}
                            <div class="flex flex-wrap gap-2 mt-6">${imgs}</div>
                        </div>
                        <div class="flex flex-col gap-4 ml-4">
                            ${t.status==='pending' ? `
                                <button onclick="openComp('${t.id}')" class="bg-emerald-500 text-white w-14 h-14 rounded-[1.2rem] flex items-center justify-center hover:bg-emerald-600 shadow-lg active:scale-90 transition-all"><i class="fas fa-check-circle text-2xl"></i></button>
                                <button onclick="openEdit('${t.id}')" class="bg-indigo-600 text-white w-14 h-14 rounded-[1.2rem] flex items-center justify-center hover:bg-indigo-700 shadow-lg active:scale-90 transition-all"><i class="fas fa-edit text-2xl"></i></button>
                            ` : ''}
                            <button onclick="openDel('${t.id}')" class="bg-rose-50 text-rose-300 w-14 h-14 rounded-[1.2rem] flex items-center justify-center hover:bg-rose-600 hover:text-white active:scale-90 shadow-sm"><i class="fas fa-trash-alt text-2xl"></i></button>
                        </div>
                    </div>
                </div>`;
            };

            const listActiveEl = document.getElementById('listActive');
            if(listActiveEl) listActiveEl.innerHTML = activeAll.length ? activeAll.reverse().map(makeItem).join('') : '<div class="text-center py-20 text-slate-300 font-medium uppercase tracking-widest">ไม่มีงานค้างในระบบ</div>';
            const listHistoryEl = document.getElementById('listHistory');
            if(listHistoryEl) listHistoryEl.innerHTML = doneFiltered.length ? doneFiltered.reverse().map(makeItem).join('') : '<div class="text-center py-20 text-slate-200 uppercase font-medium tracking-widest">ไม่พบประวัติข้อมูล</div>';
            const dashListEl = document.getElementById('dashList');
            if(dashListEl) dashListEl.innerHTML = activeFiltered.sort((a,b)=>(a.deadline||'9999')>(b.deadline||'9999')?1:-1).map(makeItem).join('');
            const banner = document.getElementById('todayBanner');
            const todayList = activeAll.filter(t => t.deadline === today);
            if(banner) { banner.className = todayList.length > 0 ? 'bg-rose-600 p-4 text-white text-center text-sm font-medium block animate-pulse' : 'hidden'; document.getElementById('todayCount').innerText = todayList.length; }
        }

        // --- 7. STARTUP & GLOBAL ACCESS ---
        window.openEdit = openEdit; window.openComp = openComp; window.openDel = openDel;
        window.confirmDel = confirmDel; window.update = update; window.save = save; 
        window.complete = complete; window.switchTab = switchTab; window.fetchData = fetchData;
        window.render = render; window.closeM = closeM; window.resetAssetInput = resetAssetInput;
        window.resetFilters = resetFilters; window.toggleOther = toggleOther; 
        window.toggleDeptOther = toggleDeptOther; window.handleImg = handleImg;

        window.onload = fetchData;
        window.onclick = function(e) { if (e.target.className === 'modal') { closeM('editModal'); closeM('compModal'); closeM('delModal'); } };
    </script>
</body>
</html>
