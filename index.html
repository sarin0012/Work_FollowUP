<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work Follow UP_SARIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --amber: #f59e0b;
        }

        body { 
            font-family: 'Kanit', sans-serif; 
            font-weight: 400; 
            color: #1e293b; 
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }

        .tab-active { 
            color: var(--primary); 
            font-weight: 600; 
            border-bottom: 3px solid var(--primary);
        }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { 
            background-color: #fff; 
            margin: 10% auto; 
            padding: 20px; 
            border-radius: 2rem; 
            width: 92%; 
            max-width: 450px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .compact-card {
            background: white;
            border-radius: 1.5rem;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 6px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }
        .compact-card:active { transform: scale(0.98); }
        .compact-card.overdue { border-left-color: var(--danger); background-color: #fff1f2; }
        
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast { 
            display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            padding: 12px 24px; border-radius: 1rem; z-index: 200; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            min-width: 200px; text-align: center;
        }
        .toast-error { background: var(--danger); color: white; }
        .toast-success { background: var(--success); color: white; }
    </style>
</head>
<body class="min-h-screen pb-10">
    <div id="toast" class="toast">แจ้งเตือน</div>

    <div class="max-w-xl mx-auto min-h-screen bg-slate-50 md:shadow-xl md:my-4 md:rounded-[2.5rem] overflow-hidden">
        
        <!-- Header -->
        <div class="bg-indigo-700 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Work Follow UP</h1>
                <p class="text-[10px] opacity-70 uppercase tracking-widest font-light">Sarin Systems v2.5 (Dynamic Input Update)</p>
            </div>
            <button onclick="fetchData()" class="p-3 bg-white/10 rounded-xl active:bg-white/20">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex bg-white shadow-sm px-2">
            <button onclick="switchTab('active')" id="tabActive" class="flex-1 py-3 text-sm font-medium tab-active">งานปัจจุบัน</button>
            <button onclick="switchTab('dashboard')" id="tabDashboard" class="flex-1 py-3 text-sm font-medium text-slate-400">สรุปงาน</button>
            <button onclick="switchTab('history')" id="tabHistory" class="flex-1 py-3 text-sm font-medium text-slate-400">ประวัติ</button>
        </div>

        <div class="p-4">
            <!-- Stats Bar -->
            <div id="statsBar" class="hidden grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white p-2 rounded-xl text-center border"><p class="text-[9px] text-slate-400 font-bold">รวม</p><p id="statTotal" class="text-lg font-bold">0</p></div>
                <div class="bg-amber-50 p-2 rounded-xl text-center border border-amber-100 text-amber-600"><p class="text-[9px] font-bold">ค้าง</p><p id="statPending" class="text-lg font-bold">0</p></div>
                <div class="bg-emerald-50 p-2 rounded-xl text-center border border-emerald-100 text-emerald-600"><p class="text-[9px] font-bold">เสร็จ</p><p id="statCompleted" class="text-lg font-bold">0</p></div>
                <div class="bg-red-50 p-2 rounded-xl text-center border border-red-100 text-red-600"><p class="text-[9px] font-bold">ช้า</p><p id="statOverdue" class="text-lg font-bold">0</p></div>
            </div>

            <!-- Filters -->
            <div id="filterContainer" class="hidden flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                <select id="filterMonth" onchange="render()" class="flex-1 min-w-[100px] p-2 text-xs rounded-xl bg-white border-none shadow-sm outline-none">
                    <option value="">ทุกเดือน</option>
                </select>
                <select id="filterAsset" onchange="render()" class="flex-2 min-w-[150px] p-2 text-xs rounded-xl bg-white border-none shadow-sm outline-none">
                    <option value="">ทุก โมล/เครื่อง</option>
                </select>
                <button onclick="resetFilters()" class="p-2 bg-indigo-100 text-indigo-700 rounded-xl text-xs font-bold">ล้าง</button>
            </div>

            <div id="overdueAlertBox" class="hidden bg-red-600 text-white p-3 rounded-xl mb-4 text-xs flex items-center shadow-md animate-pulse">
                <i class="fas fa-exclamation-triangle mr-2"></i> มีงานเลยกำหนด <span id="overdueAlertCount" class="font-bold mx-1">0</span> รายการ!
            </div>

            <!-- ส่วนบันทึกงาน -->
            <div id="activeSection">
                <details class="bg-white rounded-2xl mb-4 shadow-sm border overflow-hidden">
                    <summary class="p-4 cursor-pointer font-bold text-indigo-700 flex justify-between items-center text-sm">
                        <span><i class="fas fa-plus-circle mr-2"></i>บันทึกงานใหม่</span>
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </summary>
                    <div class="p-4 pt-0 space-y-3">
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">ชื่องาน / รายละเอียด (ปัญหา)</label>
                            <input type="text" id="taskInput" placeholder="อาการเสีย / ปัญหาที่พบ..." class="w-full p-3 text-sm rounded-xl bg-slate-50 border-none outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>

                        <div class="flex flex-col gap-3">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">ประเภทงาน</label>
                                <select id="typeInput" onchange="toggleJobTypeOther(this.value)" class="w-full p-3 text-sm rounded-xl bg-slate-50 border-none outline-none font-medium">
                                    <!-- กลุ่ม Mold -->
                                    <option value="Repair Mold">Repair Mold</option>
                                    <option value="Spare part Mold">Spare part Mold</option>
                                    <option value="TPM Mold">TPM Mold</option>
                                    <option value="Fit flashing">Fit flashing Mold</option>
                                    <!-- กลุ่ม Machine -->
                                    <option value="Repair machine">Repair machine</option>
                                    <option value="Spare part machine">Spare part machine</option>
                                    <option value="Machine modify">Machine modify</option>
                                    <option value="New Machine">New Machine</option>
                                    <option value="Other">Other (อื่นๆ)</option>
                                </select>
                            </div>
                            <div id="otherJobTypeWrapper" class="hidden">
                                <input type="text" id="otherJobTypeInput" placeholder="ระบุประเภทงานเอง..." class="w-full p-3 text-sm rounded-xl border-2 border-dashed border-indigo-200 bg-white outline-none">
                            </div>

                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">โมล/เครื่อง</label>
                                <input type="text" id="assetInput" list="assetList" oninput="toggleOther(this.value)" placeholder="ค้นหาหรือเลือก โมล/เครื่อง..." class="w-full p-3 text-sm rounded-xl bg-slate-50 border-none outline-none font-medium text-indigo-900">
                                <datalist id="assetList"></datalist>
                            </div>
                        </div>
                        <div id="otherAssetWrapper" class="hidden"><input type="text" id="otherAssetInput" placeholder="ระบุชื่อโมล/เครื่องใหม่..." class="w-full p-3 text-sm rounded-xl border-2 border-dashed border-indigo-200 outline-none"></div>
                        
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">ผู้รับผิดชอบ (Dept)</label>
                            <select id="deptInput" onchange="toggleDeptOther(this.value)" class="w-full p-3 text-sm rounded-xl bg-slate-50 border-none outline-none text-indigo-600 font-medium">
                                <option value="">-- เลือกผู้จัดทำ --</option>
                                <option value="TP/MDS">TP/MDS</option><option value="PE">PE</option><option value="Other">ระบุเอง</option>
                            </select>
                        </div>
                        <div id="otherDeptWrapper" class="hidden"><input type="text" id="otherDeptInput" placeholder="ระบุแผนก..." class="w-full p-3 text-sm rounded-xl bg-slate-50"></div>
                        
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">เริ่ม</label>
                                <input type="date" id="startInput" class="w-full p-2 text-sm rounded-xl bg-slate-50 border-none outline-none">
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">กำหนดเสร็จ</label>
                                <input type="date" id="endInput" class="w-full p-2 text-sm rounded-xl bg-slate-50 border-none outline-none text-red-500 font-bold">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1 ml-1">รูปภาพแจ้งซ่อม</label>
                            <input type="file" multiple accept="image/*" onchange="handleImg(this, 'preIn', 'in')" class="text-[10px] block w-full file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700">
                            <div id="preIn" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                        <button onclick="save()" id="saveBtn" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold uppercase shadow-md active:scale-95 transition-all flex justify-center items-center gap-2">
                            บันทึกข้อมูล <div class="loader" id="saveLd"></div>
                        </button>
                    </div>
                </details>
                <div id="listActive" class="space-y-2"></div>
            </div>

            <div id="dashboardSection" class="hidden space-y-2"><div id="dashList" class="space-y-2"></div></div>
            <div id="historySection" class="hidden space-y-2"><div id="listHistory" class="space-y-2"></div></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal"><div class="modal-content">
        <h2 class="text-lg font-bold text-indigo-700 mb-4 italic">แก้ไขข้อมูล</h2>
        <div class="space-y-4">
            <input type="hidden" id="edId">
            <input type="text" id="edTask" class="w-full p-3 rounded-xl bg-slate-100 border-none outline-none text-sm font-medium">
            <input type="date" id="edEnd" class="w-full p-3 rounded-xl bg-slate-100 border-none outline-none text-red-500 font-bold">
            <textarea id="edReason" rows="2" placeholder="ระบุเหตุผลการแก้ไข..." class="w-full p-3 rounded-xl bg-slate-100 border-none outline-none text-sm font-medium"></textarea>
            <button onclick="update()" id="upBtn" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold active:scale-95 flex justify-center items-center gap-2">อัปเดต <div class="loader" id="upLd"></div></button>
        </div>
    </div></div>

    <div id="compModal" class="modal"><div class="modal-content text-center">
        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-check"></i></div>
        <h2 class="text-xl font-bold mb-2 uppercase">ปิดงานซ่อม</h2>
        <input type="file" multiple accept="image/*" onchange="handleImg(this, 'preOut', 'out')" class="text-xs mb-4">
        <div id="preOut" class="flex flex-wrap gap-2 mb-4 justify-center"></div>
        <div class="flex gap-2"><button onclick="closeM('compModal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-400">ยกเลิก</button><button onclick="complete()" id="cpBtn" class="flex-2 py-3 bg-emerald-600 text-white rounded-xl font-bold uppercase flex justify-center items-center gap-2">ยืนยัน <div class="loader" id="cpLd"></div></button></div>
    </div></div>

    <div id="delModal" class="modal"><div class="modal-content text-center">
        <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-trash-alt"></i></div>
        <h2 class="text-lg font-bold mb-6 uppercase">ยืนยันการลบ?</h2>
        <div class="flex gap-2"><button onclick="closeM('delModal')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-400">ยกเลิก</button><button onclick="confirmDel()" id="delBtn" class="flex-2 py-3 bg-red-600 text-white rounded-xl font-bold uppercase flex justify-center items-center gap-2">ลบถาวร <div class="loader" id="delLd"></div></button></div>
    </div></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX4EWwdUgmL9KqL_lKmTuh0-K6TGhAO-UVwa0dka2aQkkkOV_OrffP7VvVzOMPLTtzjQ/exec";
        let tasks = [], inImgs = [], outImgs = [], masterAssets = [], curId = "", currentTab = "active", targetDelId = "";

        // --- Core Helpers ---
        function formatThaiDate(dStr) {
            if (!dStr || dStr === "-") return "-";
            try {
                const d = new Date(dStr);
                if (isNaN(d.getTime())) return dStr;
                return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()+543}`;
            } catch(e) { return dStr; }
        }

        function showToast(m, t='success') {
            const x = document.getElementById('toast'); if(!x) return;
            x.innerText = m; x.className = `toast toast-${t}`; x.style.display = 'block';
            setTimeout(() => { x.style.display = 'none'; }, 4000);
        }

        function closeM(id) { const el = document.getElementById(id); if(el) el.style.display = 'none'; }

        // --- Data Logic ---
        async function fetchWithRetry(url, opt = {}, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, opt);
                    if (!res.ok) throw new Error('Fail');
                    return res;
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }

        async function fetchData() {
            try {
                const res = await fetchWithRetry(SCRIPT_URL.trim());
                const data = await res.json();
                tasks = data.tasks || []; masterAssets = data.assets || [];
                updateMasterAssetList(); updateFilters(); render();
            } catch (e) { console.error(e); showToast("ดึงข้อมูลล้มเหลว", 'error'); }
        }

        async function handleImg(input, preId, type) {
            const pre = document.getElementById(preId); if(!pre) return; pre.innerHTML = '';
            const target = type === 'in' ? inImgs : outImgs; target.length = 0;
            if (input.files) {
                for (let f of Array.from(input.files)) {
                    const r = new FileReader(); r.readAsDataURL(f);
                    r.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const can = document.createElement('canvas'); const ctx = can.getContext('2d');
                            let w = img.width, h = img.height; if(w > 800) { h = (800/w)*h; w = 800; }
                            can.width = w; can.height = h; ctx.drawImage(img, 0, 0, w, h);
                            const b64 = can.toDataURL('image/jpeg', 0.6); target.push(b64);
                            const i = document.createElement('img'); i.src = b64; i.className = "w-10 h-10 object-cover rounded-lg border"; pre.appendChild(i);
                        };
                    };
                }
            }
        }

        window.save = async function() {
            const task = document.getElementById('taskInput').value;
            const start = document.getElementById('startInput').value;
            const end = document.getElementById('endInput').value;
            if(!task || !end) return alert("ข้อมูลไม่ครบ");
            const btn = document.getElementById('saveBtn'); const ld = document.getElementById('saveLd');
            btn.disabled = true; if(ld) ld.style.display = "block";

            // จัดการประเภทงาน (Job Type)
            let type = document.getElementById('typeInput').value;
            if(type === "Other") {
                type = document.getElementById('otherJobTypeInput').value.trim();
                if(!type) { btn.disabled = false; ld.style.display="none"; return alert("กรุณาระบุประเภทงานเอง"); }
            }

            // จัดการโมล/เครื่อง
            let asset = document.getElementById('assetInput').value.trim();
            if(asset === "อื่นๆ (ระบุเอง)") asset = document.getElementById('otherAssetInput').value.trim();
            if(!asset) { btn.disabled = false; ld.style.display="none"; return alert("กรุณาเลือกโมล/เครื่อง"); }

            // จัดการแผนก
            let dept = document.getElementById('deptInput').value;
            if(dept === "Other") dept = document.getElementById('otherDeptInput').value.trim();
            if(!dept) { btn.disabled = false; ld.style.display="none"; return alert("กรุณาเลือกแผนก"); }

            try {
                await fetchWithRetry(SCRIPT_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "add", task, type: type, asset, startDate: start, deadline: end, images: inImgs, vendor: dept }) 
                });
                showToast("บันทึกสำเร็จ"); setTimeout(() => location.reload(), 1000);
            } catch(e) { showToast("บันทึกไม่สำเร็จ", 'error'); btn.disabled = false; if(ld) ld.style.display = "none"; }
        };

        window.update = async function() {
            const id = document.getElementById('edId').value;
            const task = document.getElementById('edTask').value;
            const deadline = document.getElementById('edEnd').value;
            const reason = document.getElementById('edReason').value;
            const btn = document.getElementById('upBtn'); const ld = document.getElementById('upLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            try {
                const idx = tasks.findIndex(t => t.id === id);
                if(idx !== -1) { tasks[idx].task = task; tasks[idx].deadline = deadline; tasks[idx].reason = reason; }
                render();
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "update", id, task, deadline, reason }) });
                showToast("อัปเดตสำเร็จ"); closeM('editModal'); await fetchData();
            } catch (e) { showToast("อัปเดตล้มเหลว", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; }
        };

        window.complete = async function() {
            const btn = document.getElementById('cpBtn'); const ld = document.getElementById('cpLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            try {
                const idx = tasks.findIndex(t => t.id === curId);
                if(idx !== -1) tasks[idx].status = 'completed';
                render();
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "complete", id: curId, images: outImgs }) });
                showToast("ปิดงานสำเร็จ"); closeM('compModal'); await fetchData();
            } catch (e) { showToast("ปิดงานไม่สำเร็จ", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; }
        };

        window.confirmDel = async function() {
            if(!targetDelId) return;
            const btn = document.getElementById('delBtn'); const ld = document.getElementById('delLd');
            btn.disabled = true; if(ld) ld.style.display = "block";
            const oldT = [...tasks]; tasks = tasks.filter(t => t.id !== targetDelId); render();
            try {
                await fetchWithRetry(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", id: targetDelId }) });
                showToast("ลบข้อมูลสำเร็จ"); closeM('delModal');
            } catch(e) { tasks = oldT; render(); showToast("ลบไม่สำเร็จ", 'error'); } finally { btn.disabled = false; if(ld) ld.style.display = "none"; targetDelId = ""; }
        };

        // --- UI Rendering ---
        function updateMasterAssetList() {
            const l = document.getElementById('assetList'); if(!l) return;
            l.innerHTML = masterAssets.map(a => `<option value="${(typeof a === 'object') ? a.fullText : a}">`).join('') + '<option value="อื่นๆ (ระบุเอง)">';
        }

        function updateFilters() {
            const fA = document.getElementById('filterAsset'); const fM = document.getElementById('filterMonth');
            if(!fA || !fM) return;
            let relS = currentTab === 'dashboard' ? 'pending' : 'completed';
            const molds = [...new Set(tasks.filter(t => t.status === relS).map(t => t.asset))].sort();
            fA.innerHTML = '<option value="">โมล/เครื่อง: ทั้งหมด</option>' + molds.map(a => `<option value="${a}">${a}</option>`).join('');
            const mons = [...new Set(tasks.filter(t => t.deadline).map(t => t.deadline.toString().substring(0, 7)))].filter(m => m).sort().reverse();
            fM.innerHTML = '<option value="">ทุกเดือน</option>' + mons.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        window.switchTab = function(mode) {
            currentTab = mode; if (mode === 'active') resetFilters();
            ['tabActive', 'tabDashboard', 'tabHistory'].forEach(id => {
                const el = document.getElementById(id); if(el) el.classList.remove('tab-active');
            });
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('tab-active');
            ['activeSection', 'dashboardSection', 'historySection'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            document.getElementById(mode + 'Section').classList.remove('hidden');
            document.getElementById('statsBar').style.display = (mode === 'dashboard' || mode === 'history') ? 'grid' : 'none';
            document.getElementById('filterContainer').style.display = (mode === 'dashboard' || mode === 'history') ? 'flex' : 'none';
            updateFilters(); render();
        };

        function render() {
            const today = new Date().toLocaleDateString('en-CA');
            const fm = document.getElementById('filterMonth') ? document.getElementById('filterMonth').value : "";
            const fa = document.getElementById('filterAsset') ? document.getElementById('filterAsset').value : "";
            const filtered = tasks.filter(t => (!fa || t.asset === fa) && (!fm || (t.deadline && String(t.deadline).startsWith(fm))));
            const activeFiltered = filtered.filter(t => t.status === 'pending');
            const doneFiltered = filtered.filter(t => t.status === 'completed');
            const activeAll = tasks.filter(t => t.status === 'pending');
            const overdueAll = activeAll.filter(t => t.deadline && t.deadline < today);

            if(document.getElementById('statTotal')) document.getElementById('statTotal').innerText = filtered.length;
            if(document.getElementById('statPending')) document.getElementById('statPending').innerText = activeFiltered.length;
            if(document.getElementById('statCompleted')) document.getElementById('statCompleted').innerText = doneFiltered.length;
            if(document.getElementById('statOverdue')) document.getElementById('statOverdue').innerText = activeFiltered.filter(t => t.deadline && t.deadline < today).length;

            const ab = document.getElementById('overdueAlertBox');
            if(ab) { if(overdueAll.length > 0) { ab.classList.remove('hidden'); document.getElementById('overdueAlertCount').innerText = overdueAll.length; } else { ab.classList.add('hidden'); } }

            const makeItem = t => {
                const isOver = t.status === 'pending' && t.deadline < today;
                const rawImgs = (t.imageUrl ? t.imageUrl.split(',') : []).concat(t.finishImageUrl ? t.finishImageUrl.split(',') : []);
                const imgs = rawImgs.map(u => u.trim()).filter(u => u && u.startsWith('http'))
                    .map(u => `<img src="${u}" onclick="window.open('${u}')" class="w-8 h-8 object-cover rounded-md border border-slate-200">`).join('');
                
                return `
                <div class="compact-card ${isOver?'overdue':''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[8px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 uppercase">${t.type}</span>
                                ${isOver?'<span class="text-[8px] font-bold px-1.5 py-0.5 rounded bg-red-600 text-white animate-pulse">LATE</span>':''}
                            </div>
                            <h3 class="text-md font-semibold text-slate-800 leading-tight italic"><i class="fas fa-tools mr-1 opacity-50"></i>${t.task||'ปัญหา'}</h3>
                            <p class="text-[11px] text-indigo-600 font-medium italic"><i class="fas fa-cube mr-1 opacity-50"></i>${t.asset||'ไม่ระบุ'}</p>
                            <div class="flex items-center gap-3 mt-2">
                                <div class="text-[10px] text-slate-500 font-medium"><i class="far fa-calendar-alt mr-1"></i>${formatThaiDate(t.deadline)}</div>
                                <div class="text-[10px] text-slate-400 font-medium">Resp: ${t.vendor||'-'}</div>
                                <div class="flex gap-1">${imgs}</div>
                            </div>
                            ${t.reason?`<div class="mt-2 text-[9px] text-amber-700 bg-amber-50 p-1 rounded px-2 font-medium italic">Note: ${t.reason}</div>`:''}
                        </div>
                        <div class="flex gap-1 ml-2">
                            ${t.status==='pending' ? `
                                <button onclick="openComp('${t.id}')" class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center"><i class="fas fa-check text-xs"></i></button>
                                <button onclick="openEdit('${t.id}')" class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center"><i class="fas fa-edit text-xs"></i></button>
                            ` : ''}
                            <button onclick="openDel('${t.id}')" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-300 flex items-center justify-center active:bg-red-500 active:text-white"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>
                </div>`;
            };

            const listA = document.getElementById('listActive');
            if(listA) listA.innerHTML = activeAll.length ? activeAll.reverse().map(makeItem).join('') : '<p class="text-center py-10 text-slate-300 text-xs uppercase font-bold tracking-widest">No pending tasks</p>';
            const listH = document.getElementById('listHistory');
            if(listH) listH.innerHTML = doneFiltered.length ? doneFiltered.reverse().map(makeItem).join('') : '<p class="text-center py-10 text-slate-300 text-xs">No history</p>';
            const listD = document.getElementById('dashList');
            if(listD) listD.innerHTML = activeFiltered.sort((a,b)=>(a.deadline||'9999')>(b.deadline||'9999')?1:-1).map(makeItem).join('');
            
            const tb = document.getElementById('todayBanner');
            const tl = activeAll.filter(t => t.deadline === today);
            if(tb) { tb.style.display = tl.length > 0 ? 'block' : 'none'; document.getElementById('todayCount').innerText = tl.length; }
        }

        // --- Global Access ---
        window.openEdit = id => openEdit(id);
        window.openComp = id => openComp(id);
        window.openDel = id => openDel(id);
        window.toggleOther = v => { const el = document.getElementById('otherAssetWrapper'); if(el) el.className = v.trim() === "อื่นๆ (ระบุเอง)" ? "block mt-1" : "hidden"; };
        window.toggleDeptOther = v => { const el = document.getElementById('otherDeptWrapper'); if(el) el.className = v === "Other" ? "block mt-1" : "hidden"; };
        window.toggleJobTypeOther = v => { const el = document.getElementById('otherJobTypeWrapper'); if(el) el.className = v === "Other" ? "block mt-1" : "hidden"; if(v==="Other") document.getElementById('otherJobTypeInput').focus(); };
        window.resetAssetInput = () => { const el = document.getElementById('assetInput'); if(el) { el.value = ""; toggleOther(""); el.focus(); } };
        window.resetFilters = () => { if(document.getElementById('filterMonth')) document.getElementById('filterMonth').value = ""; if(document.getElementById('filterAsset')) document.getElementById('filterAsset').value = ""; render(); };

        window.onload = fetchData;
        window.onclick = e => { if (e.target.className === 'modal') { closeM('editModal'); closeM('compModal'); closeM('delModal'); } };
    </script>
</body>
</html>